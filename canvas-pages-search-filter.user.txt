// ==UserScript==
// @name         Canvas Pages: Search Bar Filter (Fast)
// @namespace    https://tampermonkey.net/
// @version      1.1.0
// @description  Adds a fast search bar to Canvas Pages index and filters rows as you type.
// @match        *://*/courses/*/pages
// @match        *://*/courses/*/pages?*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

(() => {
  "use strict";

  const HOST_ID = "tm-pages-search-host";
  const DEBOUNCE_INPUT_MS = 80;
  const DEBOUNCE_MUTATION_MS = 120;
  const TABLE_POLL_MS = 1200;

  let lastQuery = "";
  let tbodyObserver = null;
  let pollTimer = null;

  // Cache: row -> searchable string
  const rowText = new WeakMap();
  let cachedRows = [];

  const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

  function isPagesIndex() {
    const p = location.pathname;
    return /\/courses\/\d+\/pages\/?$/.test(p) || /\/courses\/\d+\/pages$/.test(p);
  }

  function findPagesTable() {
    const tables = Array.from(document.querySelectorAll("table"));
    for (const t of tables) {
      const thText = Array.from(t.querySelectorAll("thead th"))
        .map((th) => (th.textContent || "").trim().toLowerCase())
        .filter(Boolean);

      const hasPageTitle = thText.some((x) => x.includes("page title") || x === "title");
      const hasCreation = thText.some((x) => x.includes("creation") || x.includes("created"));
      if (hasPageTitle && hasCreation) return t;
    }

    return (
      document.querySelector('[data-testid*="pages"] table') ||
      document.querySelector("#content table") ||
      document.querySelector(".ic-Layout-contentMain table") ||
      null
    );
  }

  function getBody(table) {
    return (table && table.tBodies && table.tBodies[0]) ? table.tBodies[0] : null;
  }

  function computeRowText(tr) {
    // textContent is much cheaper than innerText
    return (tr.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
  }

  function indexRows(table) {
    const tbody = getBody(table);
    if (!tbody) {
      cachedRows = [];
      return;
    }
    cachedRows = Array.from(tbody.querySelectorAll("tr")).filter(
      (tr) => tr.querySelectorAll("td").length > 0
    );

    for (const tr of cachedRows) {
      if (!rowText.has(tr)) rowText.set(tr, computeRowText(tr));
    }
  }

  function applyFilter(query) {
    const q = (query || "").trim().toLowerCase();
    lastQuery = q;

    const total = cachedRows.length;
    let shown = 0;

    for (const tr of cachedRows) {
      // If a row wasnâ€™t cached for some reason, compute once
      let txt = rowText.get(tr);
      if (txt == null) {
        txt = computeRowText(tr);
        rowText.set(tr, txt);
      }
      const match = !q || txt.includes(q);
      tr.style.display = match ? "" : "none";
      if (match) shown++;
    }

    const host = document.getElementById(HOST_ID);
    if (host && host.shadowRoot) {
      const countEl = host.shadowRoot.getElementById("tmCount");
      if (countEl) countEl.textContent = `${shown} / ${total} shown`;
    }
  }

  function mountUIAbove(table) {
    if (document.getElementById(HOST_ID)) return;

    const host = document.createElement("div");
    host.id = HOST_ID;
    const shadow = host.attachShadow({ mode: "open" });

    const style = document.createElement("style");
    style.textContent = `
      :host{
        display:block;
        width: 50%;
        min-width: 360px;
        max-width: 640px;
      }
      @media (max-width: 900px){
        :host{ width: 100%; min-width: 0; max-width: 100%; }
      }
      .wrap{
        display:flex;
        align-items:center;
        gap:10px;
        padding:10px 12px;
        border:1px solid rgba(0,0,0,.12);
        border-radius:10px;
        background:#fff;
        margin: 0 0 12px 0;
      }
      .row{
        display:flex;
        align-items:center;
        gap:8px;
